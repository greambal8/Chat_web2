<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>üîí –°–µ–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Ç</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    #container {
      max-width: 500px;
      margin: 0 auto;
      padding: 16px;
    }
    #header {
      text-align: center;
      padding: 16px 0;
      margin-bottom: 16px;
    }
    h1 {
      color: #6366f1;
      font-size: 24px;
      margin-bottom: 8px;
    }
    .status {
      background: rgba(30, 41, 59, 0.8);
      padding: 8px 16px;
      border-radius: 12px;
      font-size: 14px;
      margin: 8px 0;
    }
    .status.secure {
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    #messages {
      height: 60vh;
      overflow-y: auto;
      padding: 16px;
      background: #1e293b;
      border-radius: 16px;
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .message {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 16px;
      position: relative;
    }
    .own {
      background: #4f46e5;
      margin-left: auto;
      color: white;
    }
    .other {
      background: #334155;
      color: white;
    }
    .sender {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      display: block;
    }
    .time {
      font-size: 12px;
      color: #94a3b8;
      text-align: right;
      margin-top: 4px;
      display: block;
    }
    #input-area {
      display: flex;
      gap: 8px;
    }
    #message-input {
      flex: 1;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid #334155;
      background: #334155;
      color: white;
      font-size: 16px;
    }
    #send-button {
      padding: 14px 24px;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 14px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
    }
    #send-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }
    .control-row {
      display: flex;
      gap: 8px;
    }
    input, button {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #334155;
      font-size: 16px;
    }
    input {
      flex: 1;
      background: #334155;
      color: white;
    }
    button {
      background: #4f46e5;
      color: white;
      cursor: pointer;
    }
    .system {
      text-align: center;
      color: #64748b;
      font-style: italic;
      padding: 8px 0;
    }
    .file-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 16px 0;
    }
    .file-btn {
      padding: 14px;
      background: #1e293b;
      border: 1px dashed #4f46e5;
      border-radius: 14px;
      text-align: center;
      cursor: pointer;
    }
    #file-input {
      display: none;
    }
    @media (max-width: 480px) {
      #container {
        padding: 8px;
      }
      #messages {
        height: 50vh;
      }
      .message {
        padding: 10px 12px;
      }
      input, button {
        padding: 10px;
        font-size: 14px;
      }
      #send-button {
        padding: 10px 16px;
      }
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="header">
      <h1>üîí –°–µ–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Ç</h1>
      <div class="status" id="status">–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é</div>
    </div>

    <div class="controls">
      <div class="control-row">
        <input type="text" id="room-input" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="room-123">
        <button id="connect-button">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
      </div>
      
      <div class="control-row" id="key-controls" style="display: none;">
        <input type="text" id="key-input" placeholder="AES-256 –∫–ª—é—á (64 hex)" maxlength="64">
        <button id="generate-key">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="activate-key">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>

    <div class="file-controls" id="file-controls" style="display: none;">
      <div class="file-btn" id="load-file-btn">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å Christmas.by</div>
      <div class="file-btn" id="create-file-btn">üíæ –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª</div>
    </div>

    <div id="messages">
      <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
    </div>

    <div id="input-area" style="display: none;">
      <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
      <button id="send-button" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <input type="file" id="file-input" accept=".by" style="display: none;">

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let client = null;
    let currentTopic = null;
    let encryptionKey = null;
    let isEncrypted = false;
    let clientId = 'client-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
    let participants = new Map(); // clientId -> name
    let messageIds = new Set(); // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    
    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const roomInput = document.getElementById('room-input');
    const connectButton = document.getElementById('connect-button');
    const keyControls = document.getElementById('key-controls');
    const keyInput = document.getElementById('key-input');
    const generateKeyBtn = document.getElementById('generate-key');
    const activateKeyBtn = document.getElementById('activate-key');
    const fileControls = document.getElementById('file-controls');
    const loadFileBtn = document.getElementById('load-file-btn');
    const createFileBtn = document.getElementById('create-file-btn');
    const messagesDiv = document.getElementById('messages');
    const inputArea = document.getElementById('input-area');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const statusDiv = document.getElementById('status');
    const fileInput = document.getElementById('file-input');
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–º–µ–Ω–∏
    function generateRandomName() {
      const colors = ['–°–∏–Ω–∏–π', '–ö—Ä–∞—Å–Ω—ã–π', '–ó–µ–ª–µ–Ω—ã–π', '–ñ–µ–ª—Ç—ã–π', '–§–∏–æ–ª–µ—Ç–æ–≤—ã–π', '–û—Ä–∞–Ω–∂–µ–≤—ã–π'];
      const animals = ['–í–æ–ª–∫', '–õ–∏—Å–∞', '–°–æ–≤–∞', '–¢–∏–≥—Ä', '–ú–µ–¥–≤–µ–¥—å', '–û—Ä–µ–ª'];
      return `${colors[Math.floor(Math.random() * colors.length)]} ${animals[Math.floor(Math.random() * animals.length)]}`;
    }
    
    let selfName = generateRandomName();
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString('ru-RU', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false
      });
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ UI
    function addMessage(text, senderName, isOwn, timestamp, isSystem = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
      
      if (isSystem) {
        messageDiv.className = 'system';
        messageDiv.textContent = text;
      } else {
        messageDiv.innerHTML = `
          <span class="sender">${senderName}</span>
          <div>${text}</div>
          <span class="time">${formatTime(timestamp)}</span>
        `;
      }
      
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    function updateStatus(text, isSecure = false) {
      statusDiv.textContent = text;
      statusDiv.className = 'status' + (isSecure ? ' secure' : '');
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ AES –∫–ª—é—á–∞
    function generateAESKey() {
      const array = new Uint8Array(32);
      window.crypto.getRandomValues(array);
      return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
    }
    
    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MQTT
    function connectToRoom(roomId) {
      if (client) {
        client.end();
      }
      
      currentTopic = `secret-chat/${roomId}`;
      client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt', {
        clientId: clientId,
        reconnectPeriod: 3000
      });
      
      client.on('connect', () => {
        console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ MQTT');
        client.subscribe(currentTopic, { qos: 1 });
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        const joinMessage = JSON.stringify({
          type: 'join',
          clientId: clientId,
          name: selfName,
          timestamp: Date.now()
        });
        
        client.publish(currentTopic, joinMessage, { qos: 1 });
        updateStatus(`–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ: ${roomId}`);
      });
      
      client.on('message', (topic, payload) => {
        if (topic !== currentTopic) return;
        
        try {
          const message = JSON.parse(payload.toString());
          handleMessage(message);
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
        }
      });
      
      client.on('error', (error) => {
        console.error('MQTT –æ—à–∏–±–∫–∞:', error);
        updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
      });
      
      client.on('reconnect', () => {
        updateStatus('üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...');
      });
      
      client.on('offline', () => {
        updateStatus('‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    function handleMessage(message) {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç –ø–æ ID
      if (message.id && messageIds.has(message.id)) {
        return;
      }
      
      if (message.id) {
        messageIds.add(message.id);
      }
      
      const timestamp = message.timestamp || Date.now();
      
      // –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      if (message.type === 'join') {
        if (message.clientId !== clientId) {
          participants.set(message.clientId, message.name);
          addMessage(`${message.name} –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ —á–∞—Ç—É`, '–°–∏—Å—Ç–µ–º–∞', false, timestamp, true);
        }
        return;
      }
      
      // –û–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      if (message.type === 'message') {
        let content = message.content;
        let senderName = message.sender || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
        const isOwn = message.clientId === clientId;
        
        // –î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (isEncrypted && message.encrypted) {
          try {
            content = decryptMessage(message.encrypted);
          } catch (e) {
            content = '[‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏]';
          }
        }
        
        addMessage(content, senderName, isOwn, timestamp);
      }
    }
    
    // –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function encryptMessage(text) {
      if (!encryptionKey) return null;
      
      const iv = window.crypto.getRandomValues(new Uint8Array(12));
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      
      const key = await window.crypto.subtle.importKey(
        'raw',
        hexToBuffer(encryptionKey),
        { name: 'AES-GCM' },
        false,
        ['encrypt']
      );
      
      const encrypted = await window.crypto.subtle.encrypt(
        { name: 'AES-GCM', iv },
        key,
        data
      );
      
      const buffer = new Uint8Array(iv.byteLength + encrypted.byteLength);
      buffer.set(iv, 0);
      buffer.set(new Uint8Array(encrypted), iv.byteLength);
      
      return arrayBufferToBase64(buffer.buffer);
    }
    
    // –î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function decryptMessage(encryptedData) {
      if (!encryptionKey) return encryptedData;
      
      const buffer = base64ToArrayBuffer(encryptedData);
      const iv = buffer.slice(0, 12);
      const data = buffer.slice(12);
      
      const key = await window.crypto.subtle.importKey(
        'raw',
        hexToBuffer(encryptionKey),
        { name: 'AES-GCM' },
        false,
        ['decrypt']
      );
      
      const decrypted = await window.crypto.subtle.decrypt(
        { name: 'AES-GCM', iv },
        key,
        data
      );
      
      const decoder = new TextDecoder();
      return decoder.decode(decrypted);
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏
    function hexToBuffer(hex) {
      const buffer = new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
      return buffer;
    }
    
    function arrayBufferToBase64(buffer) {
      return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)));
    }
    
    function base64ToArrayBuffer(base64) {
      const binaryString = atob(base64);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes;
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !client || !client.connected) return;
      
      const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
      let contentToSend = text;
      let encryptedContent = null;
      
      if (isEncrypted) {
        try {
          encryptedContent = await encryptMessage(text);
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', e);
          alert('–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è');
          return;
        }
      }
      
      const message = {
        id: messageId,
        type: 'message',
        content: text,
        encrypted: encryptedContent,
        sender: selfName,
        clientId: clientId,
        timestamp: Date.now()
      };
      
      client.publish(currentTopic, JSON.stringify(message), { qos: 1 });
      
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É
      addMessage(text, selfName, true, message.timestamp);
      
      messageInput.value = '';
      messageInput.focus();
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ ID –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      if (!roomInput.value) {
        roomInput.value = 'room-' + Math.random().toString(36).substr(2, 8);
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      connectButton.addEventListener('click', () => {
        const roomId = roomInput.value.trim();
        if (!roomId) {
          alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
          return;
        }
        connectToRoom(roomId);
        keyControls.style.display = 'flex';
      });
      
      generateKeyBtn.addEventListener('click', () => {
        keyInput.value = generateAESKey();
        updateStatus('üîë –ö–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω. –ù–∞–∂–º–∏—Ç–µ "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å" –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.');
      });
      
      activateKeyBtn.addEventListener('click', async () => {
        const key = keyInput.value.trim();
        if (!key || !/^[0-9a-fA-F]{64}$/.test(key)) {
          alert('–ö–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 64 —Å–∏–º–≤–æ–ª–∞ hex (0-9, a-f)');
          return;
        }
        
        encryptionKey = key;
        isEncrypted = true;
        keyControls.style.display = 'none';
        fileControls.style.display = 'flex';
        inputArea.style.display = 'flex';
        sendButton.disabled = false;
        updateStatus('üîí –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ', true);
        addMessage('–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ. –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω—ã.', '–°–∏—Å—Ç–µ–º–∞', false, Date.now(), true);
      });
      
      loadFileBtn.addEventListener('click', () => {
        fileInput.click();
      });
      
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.name.endsWith('.by')) {
          alert('–§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
        } else {
          alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .by');
        }
      });
      
      createFileBtn.addEventListener('click', () => {
        alert('–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
      });
      
      sendButton.addEventListener('click', sendMessage);
      
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
      
      // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
      messageInput.addEventListener('focus', () => {
        if (messageInput.value === '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...') {
          messageInput.value = '';
        }
      });
      
      messageInput.addEventListener('blur', () => {
        if (!messageInput.value.trim()) {
          messageInput.value = '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...';
        }
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      setTimeout(() => {
        addMessage('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Ç! –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è".', '–°–∏—Å—Ç–µ–º–∞', false, Date.now(), true);
      }, 500);
    }
    
    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
