<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üîí –°–ï–ö–†–ï–¢–ù–´–ô –ß–ê–¢</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      margin: 0;
      padding: 12px;
      color: #e2e8f0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    #chat-container {
      width: 100%;
      max-width: 500px;
      background: #1e293b;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      overflow: hidden;
    }
    #messages {
      height: 340px;
      overflow-y: auto;
      padding: 12px;
      background: #0f172a;
    }
    .msg {
      margin-bottom: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 15px;
      line-height: 1.4;
    }
    .my { background: #4f46e5; color: white; margin-left: auto; }
    .theirs { background: #334155; color: white; }
    .system {
      text-align: center;
      color: #94a3b8;
      font-size: 13px;
      margin: 8px 0;
    }
    .panel {
      padding: 12px;
      background: #1e293b;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    input, button, label {
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #334155;
      font-size: 15px;
      background: #334155;
      color: #f1f5f9;
      min-width: 0;
    }
    #room-id, #key-input, #msg-input {
      flex: 1;
      min-width: 120px;
    }
    button {
      background: #4f46e5;
      cursor: pointer;
      white-space: nowrap;
    }
    button.danger { background: #dc2626; }
    #input-area, #file-area {
      display: none;
      padding: 16px 12px;
      background: #0f172a;
      border-top: 1px solid #334155;
      text-align: center;
    }
    #file-input {
      display: none;
    }
    #file-label {
      display: inline-block;
      padding: 10px 16px;
      background: #334155;
      border-radius: 10px;
      cursor: pointer;
    }
    #kill-btn {
      margin: 0 12px 12px;
      padding: 12px;
      width: calc(100% - 24px);
    }
    #status {
      padding: 10px;
      text-align: center;
      font-size: 13px;
      color: #94a3b8;
      background: #0f172a;
    }
    #persist-label {
      display: flex;
      align-items: center;
      gap: 6px;
      background: transparent;
      border: none;
      color: #cbd5e1;
      font-size: 14px;
    }
    @media (max-width: 520px) {
      .panel { flex-direction: column; align-items: stretch; }
      #room-id, #key-input, #msg-input { width: 100%; }
    }
  </style>
</head>
<body>

<div id="chat-container">
  <div class="panel">
    <input type="text" id="room-id" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã">
    <button id="connect-btn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <label id="persist-label">
      <input type="checkbox" id="persist-checkbox">
      –£–¥–µ—Ä–∂–∞–Ω–∏–µ
    </label>
  </div>

  <div class="panel" id="key-panel" style="display:none;">
    <input type="text" id="key-input" placeholder="–ö–ª—é—á (64 hex)" maxlength="64">
    <button id="gen-key">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
    <button id="use-key">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>

  <div id="file-area">
    <div>–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –¥–ª—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:</div>
    <button id="create-file">–°–æ–∑–¥–∞—Ç—å Christmas.by</button>
    <div style="margin-top:12px;">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ñ–∞–π–ª:</div>
    <input type="file" id="file-input" accept=".by">
    <label for="file-input" id="file-label">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª .by</label>
  </div>

  <div id="messages"></div>

  <div id="input-area">
    <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
    <button id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>

  <div id="status">–ì–æ—Ç–æ–≤ –∫ –∑–∞—â–∏—â—ë–Ω–Ω–æ–º—É –æ–±—â–µ–Ω–∏—é</div>
  <button id="kill-btn" class="danger">KILL-CHAT</button>
</div>

<script>
const roomInput = document.getElementById('room-id');
const connectBtn = document.getElementById('connect-btn');
const persistCheckbox = document.getElementById('persist-checkbox');
const keyPanel = document.getElementById('key-panel');
const keyInput = document.getElementById('key-input');
const genKeyBtn = document.getElementById('gen-key');
const useKeyBtn = document.getElementById('use-key');
const fileArea = document.getElementById('file-area');
const createFileBtn = document.getElementById('create-file');
const fileInput = document.getElementById('file-input');
const messagesDiv = document.getElementById('messages');
const inputArea = document.getElementById('input-area');
const msgInput = document.getElementById('msg-input');
const sendBtn = document.getElementById('send-btn');
const statusDiv = document.getElementById('status');
const killBtn = document.getElementById('kill-btn');

let currentTopic = null;
let aesKey = null;
let isConnected = false;
let isKeySet = false;
let messageHistory = [];
let isAutoMode = false;

// MQTT
const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

// === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
const generateRoomId = () => 'r-' + Math.random().toString(36).substring(2, 10);

const setStatus = (msg) => { statusDiv.textContent = msg; };

const addMessageToUI = (text, isOwn) => {
  const div = document.createElement('div');
  div.className = `msg ${isOwn ? 'my' : 'theirs'}`;
  div.textContent = text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
};

const addSystemMsg = (text) => {
  const div = document.createElement('div');
  div.className = 'system';
  div.textContent = text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
};

const saveSession = () => {
  if (!persistCheckbox.checked || !isConnected) {
    sessionStorage.removeItem('secret-chat-session');
    return;
  }
  sessionStorage.setItem('secret-chat-session', JSON.stringify({
    room: roomInput.value,
    messages: messageHistory.map(m => m.raw),
    timestamp: Date.now()
  }));
};

const loadAndDecryptHistory = async () => {
  messagesDiv.innerHTML = '';
  for (const item of messageHistory) {
    if (item.raw.startsWith('ENC:') && isKeySet) {
      const plain = await decryptMsg(item.raw);
      addMessageToUI(plain, false);
    } else {
      addMessageToUI('[üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ]', false);
    }
  }
};

const encryptMsg = async (plaintext) => {
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encoded = new TextEncoder().encode(plaintext);
  const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, aesKey, encoded);
  const combined = new Uint8Array(iv.length + cipher.byteLength);
  combined.set(iv, 0);
  combined.set(new Uint8Array(cipher), iv.length);
  return 'ENC:' + btoa(String.fromCharCode.apply(null, combined));
};

const decryptMsg = async (payload) => {
  if (!payload.startsWith('ENC:')) return '[–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç]';
  try {
    const b64 = payload.slice(4);
    const combined = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    const iv = combined.slice(0, 12);
    const ct = combined.slice(12);
    const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, aesKey, ct);
    return new TextDecoder().decode(decrypted);
  } catch (e) {
    return '[‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏]';
  }
};

// === –§–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ===
const createChristmasFile = () => {
  if (!isConnected || !isKeySet) {
    alert('–°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –∫–ª—é—á!');
    return;
  }
  const data = {
    v: 1,
    room: roomInput.value,
    key: currentKeyHex
  };
  const json = JSON.stringify(data);
  const blob = new Blob([json], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Christmas.by';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  setStatus('‚úÖ –§–∞–π–ª Christmas.by —Å–æ–∑–¥–∞–Ω!');
};

const loadChristmasFile = (file) => {
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const content = e.target.result;
      const data = JSON.parse(content);
      if (data.v !== 1 || !data.room || !/^[0-9a-f]{64}$/.test(data.key)) {
        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç');
      }
      isAutoMode = true;
      setStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ–∞–π–ª...');
      connectBtn.disabled = true;
      roomInput.disabled = true;
      await connectToRoom(data.room);
      await activateKey(data.key);
    } catch (err) {
      alert('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ .by');
      setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
    }
  };
  reader.readAsText(file);
};

// === –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è ===
const connectToRoom = (room) => {
  return new Promise((resolve) => {
    currentTopic = `sc-${room}`;
    client.subscribe(currentTopic);
    isConnected = true;
    roomInput.value = room;
    roomInput.disabled = true;
    connectBtn.disabled = true;
    keyPanel.style.display = 'flex';
    setStatus(`–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫: ${room}`);
    resolve();
  });
};

let currentKeyHex = '';
const activateKey = async (hex) => {
  const keyBuf = new Uint8Array(hex.match(/.{2}/g).map(b => parseInt(b, 16)));
  aesKey = await crypto.subtle.importKey('raw', keyBuf.buffer, { name: 'AES-GCM' }, false, ['encrypt', 'decrypt']);
  isKeySet = true;
  currentKeyHex = hex;

  keyPanel.style.display = 'none';
  inputArea.style.display = 'block';
  fileArea.style.display = 'block';
  setStatus('‚úÖ –ö–ª—é—á –∞–∫—Ç–∏–≤–µ–Ω. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ.');
  addSystemMsg('üîí –ó–∞—â–∏—â—ë–Ω–Ω—ã–π –∫–∞–Ω–∞–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.');
  await loadAndDecryptHistory();
  saveSession();

  if (isAutoMode) {
    // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–µ–µ, –Ω–æ URL –Ω–µ —Ç—Ä–æ–≥–∞–µ–º ‚Äî —Ñ–∞–π–ª–∞ –Ω–µ—Ç –≤ –Ω—ë–º
  }
};

const send = async () => {
  if (!isConnected || !isKeySet) return;
  const text = msgInput.value.trim();
  if (!text) return;
  const encrypted = await encryptMsg(text);
  client.publish(currentTopic, encrypted, { qos: 1 });
  messageHistory.push({ raw: encrypted });
  addMessageToUI(text, true);
  msgInput.value = '';
  saveSession();
};

const resetChat = () => {
  if (currentTopic) client.publish(currentTopic, 'SYS:WIPE', { qos: 1 });
  aesKey = null;
  isConnected = false;
  isKeySet = false;
  messageHistory = [];
  isAutoMode = false;
  roomInput.disabled = false;
  connectBtn.disabled = false;
  keyPanel.style.display = 'none';
  fileArea.style.display = 'none';
  inputArea.style.display = 'none';
  messagesDiv.innerHTML = '';
  persistCheckbox.checked = false;
  sessionStorage.removeItem('secret-chat-session');
  roomInput.value = generateRoomId();
  setStatus('–ß–∞—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω. –ù–∞—á–∞—Ç–∞ –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è.');
};

// === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
const init = () => {
  const saved = sessionStorage.getItem('secret-chat-session');
  if (saved) {
    try {
      const s = JSON.parse(saved);
      if (Date.now() - s.timestamp < 86400000) {
        roomInput.value = s.room;
        messageHistory = s.messages.map(m => ({ raw: m }));
        persistCheckbox.checked = true;
        return;
      }
    } catch (e) {}
  }
  if (!roomInput.value) {
    roomInput.value = generateRoomId();
  }
};

// === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ===
connectBtn.onclick = () => {
  const room = roomInput.value.trim();
  if (!room) { alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã'); return; }
  connectToRoom(room);
  saveSession();
};

genKeyBtn.onclick = () => {
  const arr = new Uint8Array(32);
  crypto.getRandomValues(arr);
  keyInput.value = Array.from(arr, b => b.toString(16).padStart(2, '0')).join('');
};

useKeyBtn.onclick = () => {
  const hex = keyInput.value.trim().toLowerCase();
  if (!/^[0-9a-f]{64}$/.test(hex)) {
    alert('–ö–ª—é—á ‚Äî 64 —Å–∏–º–≤–æ–ª–∞ hex (0-9, a-f)');
    return;
  }
  activateKey(hex);
};

createFileBtn.onclick = createChristmasFile;
fileInput.onchange = (e) => {
  const file = e.target.files[0];
  if (file && file.name.endsWith('.by')) {
    loadChristmasFile(file);
  } else {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .by');
  }
};

sendBtn.onclick = send;
msgInput.onkeypress = (e) => { if (e.key === 'Enter') send(); };
killBtn.onclick = resetChat;
persistCheckbox.onchange = saveSession;

// –ó–∞–ø—É—Å–∫
window.onload = init;

client.on('message', async (topic, payload) => {
  if (topic !== currentTopic) return;
  const msg = payload.toString();
  messageHistory.push({ raw: msg });
  if (isKeySet) {
    const plain = await decryptMsg(msg);
    addMessageToUI(plain, false);
  } else {
    addMessageToUI('[üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ]', false);
  }
  saveSession();
});
</script>
</body>
</html>
