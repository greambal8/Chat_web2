<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>üîí –°–µ–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Ç</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #1e293b;
      --dark: #0f172a;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --light: #f1f5f9;
      --gray: #64748b;
      --border: #334155;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      height: 100%;
      touch-action: manipulation;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--dark);
      color: var(--light);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      overscroll-behavior: contain;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    #chat-container {
      background: var(--secondary);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
      max-height: 100vh;
    }
    
    #header {
      padding: 12px 16px;
      background: rgba(30, 41, 59, 0.8);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--warning);
    }
    
    .status-dot.connected {
      background: var(--success);
    }
    
    .status-dot.secure {
      background: var(--success);
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
    }
    
    #control-panel {
      padding: 12px;
      background: var(--dark);
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    
    .control-group {
      display: flex;
      gap: 8px;
      flex: 1;
      min-width: 200px;
    }
    
    #key-panel {
      padding: 12px;
      background: rgba(99, 102, 241, 0.1);
      border-bottom: 1px solid var(--primary);
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    
    #key-input {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #1e293b;
      color: var(--light);
      font-family: monospace;
      font-size: 14px;
      min-height: 48px;
    }
    
    .key-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      -webkit-overflow-scrolling: touch;
    }
    
    .msg {
      max-width: 85%;
      padding: 16px;
      border-radius: 18px;
      position: relative;
      animation: fadeIn 0.2s ease;
      word-break: break-word;
      line-height: 1.5;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .my { 
      background: var(--primary); 
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    
    .theirs { 
      background: var(--dark); 
      border-bottom-left-radius: 4px;
    }
    
    .sender-name {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
      display: block;
    }
    
    .my .sender-name { color: #dbeafe; }
    .theirs .sender-name { color: #cbd5e1; }
    
    .message-content {
      line-height: 1.6;
      font-size: 16px;
    }
    
    .message-time {
      font-size: 13px;
      color: var(--gray);
      margin-top: 4px;
      display: block;
      text-align: right;
    }
    
    .my .message-time { color: #93c5fd; }
    .theirs .message-time { color: #94a3b8; }
    
    .encrypted-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 20px;
      height: 20px;
      background: url("image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffffff'%3E%3Cpath d='M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
    }
    
    #input-area {
      padding: 12px;
      background: var(--dark);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      position: sticky;
      bottom: 0;
      z-index: 20;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
    }
    
    #msg-input {
      flex: 1;
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #1e293b;
      color: var(--light);
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      min-height: 48px;
      max-height: 100px;
      resize: none;
      overflow-y: auto;
    }
    
    #msg-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
    }
    
    #send-btn {
      min-width: 80px;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 14px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 48px;
    }
    
    #send-btn:hover {
      background: var(--primary-dark);
    }
    
    #send-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    #file-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 12px;
      background: rgba(30, 41, 59, 0.5);
      border-top: 1px solid var(--border);
    }
    
    .file-btn {
      width: 100%;
      padding: 16px;
      border-radius: 14px;
      border: 1px dashed var(--border);
      background: transparent;
      color: var(--gray);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
      min-height: 56px;
    }
    
    .file-btn:hover {
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
      border-color: var(--primary);
    }
    
    .system-notification {
      position: fixed;
      top: max(16px, env(safe-area-inset-top));
      right: 16px;
      max-width: calc(100% - 32px);
      padding: 14px 16px;
      border-radius: 12px;
      color: white;
      font-size: 15px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transform: translateY(-100px);
      opacity: 0;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .system-notification.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .system-notification.secure {
      background: rgba(16, 185, 129, 0.95);
    }
    
    .system-notification.warning {
      background: rgba(245, 158, 11, 0.95);
    }
    
    .system-notification.danger {
      background: rgba(239, 68, 68, 0.95);
    }
    
    .btn {
      padding: 14px 16px;
      border-radius: 14px;
      border: none;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 52px;
      touch-action: manipulation;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--light);
    }
    
    .btn-secondary:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      opacity: 0.9;
    }
    
    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }
    
    .btn-warning:hover {
      opacity: 0.9;
    }
    
    #menu-panel {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100vh;
      max-width: 320px;
      background: var(--secondary);
      border-left: 1px solid var(--border);
      padding: max(20px, env(safe-area-inset-top)) 20px env(safe-area-inset-bottom) 20px;
      transition: right 0.3s ease, transform 0.3s ease;
      z-index: 100;
      box-shadow: -2px 0 10px rgba(0,0,0,0.3);
      touch-action: pan-y;
    }
    
    #menu-panel.open {
      right: 0;
      transform: translateX(0);
    }
    
    #menu-panel::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: -1;
    }
    
    #menu-panel.open::before {
      opacity: 1;
      pointer-events: auto;
    }
    
    #menu-close {
      position: absolute;
      top: max(12px, env(safe-area-inset-top));
      right: 16px;
      background: rgba(0,0,0,0.3);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    
    .menu-item {
      padding: 16px;
      border-radius: 12px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
      touch-action: manipulation;
    }
    
    .menu-item:hover {
      background: rgba(99, 102, 241, 0.1);
    }
    
    .menu-item.danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }
    
    .menu-item.danger:hover {
      background: rgba(239, 68, 68, 0.2);
    }
    
    .loading-indicator {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      margin: 0 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .control-group {
        min-width: 100%;
        flex-direction: column;
      }
      
      #room-id, #key-input, #msg-input {
        width: 100%;
      }
      
      #connect-btn, #generate-key-btn, #activate-key-btn, #send-btn {
        width: 100%;
      }
      
      #key-panel {
        padding: 16px;
      }
      
      #file-panel {
        padding: 16px;
      }
    }
    
    @media (max-width: 480px) {
      #header {
        padding: 12px 12px;
      }
      
      .status-indicator {
        font-size: 14px;
      }
      
      .control-group {
        gap: 6px;
      }
      
      .btn {
        padding: 12px;
        font-size: 15px;
      }
      
      #msg-input {
        font-size: 15px;
        padding: 12px 14px;
      }
      
      #send-btn {
        min-width: 70px;
        padding: 12px;
        font-size: 15px;
      }
      
      .msg {
        padding: 14px;
        font-size: 15px;
      }
      
      .sender-name {
        font-size: 14px;
      }
      
      .message-time {
        font-size: 12px;
      }
      
      #key-input {
        font-size: 13px;
        padding: 12px;
      }
      
      .file-btn {
        padding: 14px;
        font-size: 15px;
      }
      
      .menu-item {
        padding: 14px;
        font-size: 15px;
      }
    }
    
    @supports (-webkit-touch-callout: none) {
      input:focus, textarea:focus {
        font-size: 16px !important;
      }
      
      #msg-input {
        font-size: 16px !important;
      }
    }
  </style>
</head>
<body>

<div id="chat-container">
  <div id="header">
    <div class="status-indicator">
      <div class="status-dot" id="connection-status"></div>
      <span id="status-text">–ù–µ –ø–æ–¥–∫–ª—é—á—ë–Ω</span>
    </div>
    <div>
      <button class="btn btn-secondary" id="menu-btn">‚ò∞</button>
    </div>
  </div>

  <div id="control-panel">
    <div class="control-group">
      <input type="text" id="room-id" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" class="btn-secondary">
      <button class="btn btn-primary" id="connect-btn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    </div>
    <div class="control-group">
      <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
        <input type="checkbox" id="persist-checkbox">
        <span>–ó–∞–ø–æ–º–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é</span>
      </label>
    </div>
  </div>

  <div id="key-panel">
    <input type="text" id="key-input" placeholder="AES-256 –∫–ª—é—á (64 hex —Å–∏–º–≤–æ–ª–∞)" maxlength="64">
    <div class="key-buttons">
      <button class="btn btn-warning" id="generate-key-btn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
      <button class="btn btn-primary" id="activate-key-btn">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>

  <div id="file-panel">
    <div class="file-btn" id="load-file-btn">
      üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å Christmas.by
    </div>
    <div class="file-btn" id="create-file-btn" style="display: none;">
      üíæ –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª
    </div>
  </div>

  <div id="messages">
    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
  </div>

  <div id="input-area" style="display: none;">
    <textarea id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" rows="1"></textarea>
    <button id="send-btn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

<input type="file" id="file-input" accept=".by" style="display: none;">

<div class="system-notification" id="notification"></div>

<div id="menu-panel">
  <button id="menu-close">‚úï</button>
  <h3 style="margin-bottom: 20px; color: var(--light); font-size: 20px;">–ú–µ–Ω—é</h3>
  <div class="menu-item" id="kill-chat-btn">
    üóëÔ∏è KILL-CHAT (–ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞)
  </div>
  <div class="menu-item">
    üìã –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: <span id="participants-count">0</span>
  </div>
  <div class="menu-item">
    ‚è∞ –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: <span id="last-activity">-</span>
  </div>
  <div class="menu-item">
    üîë –°—Ç–∞—Ç—É—Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: <span id="encryption-status">–ù–µ –∞–∫—Ç–∏–≤–Ω–æ</span>
  </div>
  <div class="menu-item">
    üíª –ú–æ–π ID: <span id="client-id"></span>
  </div>
  <div class="menu-item">
    üë§ –ú–æ—ë –∏–º—è: <span id="self-name">-</span>
  </div>
</div>

<script>
// === –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ===
const state = {
  currentTopic: null,
  aesKey: null,
  isConnected: false,
  isKeySet: false,
  isSecureConnection: false,
  clientId: 'client-' + Math.random().toString(36).substring(2, 10),
  selfName: '',
  participants: new Map(), // clientId -> name
  lastMessageTime: 0,
  sentMessages: new Set(),
  messageHistory: [],
  isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
  mqttClient: null,
  messageIds: new Set() // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
};

// === –°–ü–ò–°–ö–ò –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –ò–ú–Å–ù ===
const nameColors = ['–°–∏–Ω–∏–π', '–ö—Ä–∞—Å–Ω—ã–π', '–ó–µ–ª—ë–Ω—ã–π', '–ñ—ë–ª—Ç—ã–π', '–§–∏–æ–ª–µ—Ç–æ–≤—ã–π', '–û—Ä–∞–Ω–∂–µ–≤—ã–π', '–†–æ–∑–æ–≤—ã–π', '–ì–æ–ª—É–±–æ–π', '–°–µ—Ä—ã–π', '–ë–∏—Ä—é–∑–æ–≤—ã–π', '–ò–Ω–¥–∏–≥–æ', '–ë–æ—Ä–¥–æ–≤—ã–π', '–ë—Ä–æ–Ω–∑–æ–≤—ã–π', '–°–µ—Ä–µ–±—Ä—è–Ω—ã–π', '–ó–æ–ª–æ—Ç–æ–π', '–•–∞–∫–∏', '–ú—è—Ç–Ω—ã–π', '–õ–∞–≤–∞–Ω–¥–æ–≤—ã–π', '–ë–µ–∂–µ–≤—ã–π', '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π'];
const nameAnimals = ['–í–æ–ª–∫', '–õ–∏—Å–∞', '–°–æ–≤–∞', '–Ø—Å—Ç—Ä–µ–±', '–¢–∏–≥—Ä', '–ú–µ–¥–≤–µ–¥—å', '–õ–µ–æ–ø–∞—Ä–¥', '–û—Ä—ë–ª', '–î—Ä–∞–∫–æ–Ω', '–§–µ–Ω–∏–∫—Å', '–õ–µ–≤', '–ó–º–µ—è', '–ö–æ—Ç', '–ü—ë—Å', '–ö—Ä–æ–ª–∏–∫', '–õ–æ—à–∞–¥—å', '–°–ª–æ–Ω', '–û–±–µ–∑—å—è–Ω–∞', '–ü–∞–Ω–¥–∞', '–ö—Ä–æ–∫–æ–¥–∏–ª', '–ß–µ—Ä–µ–ø–∞—Ö–∞', '–ö–∏—Ç', '–ê–∫—É–ª–∞', '–û—Å—å–º–∏–Ω–æ–≥', '–°–æ–∫–æ–ª', '–í–æ—Ä–æ–Ω', '–õ–æ—Å—å', '–Å–∂'];

// === DOM –≠–õ–ï–ú–ï–ù–¢–´ ===
const roomInput = document.getElementById('room-id');
const connectBtn = document.getElementById('connect-btn');
const persistCheckbox = document.getElementById('persist-checkbox');
const keyPanel = document.getElementById('key-panel');
const keyInput = document.getElementById('key-input');
const generateKeyBtn = document.getElementById('generate-key-btn');
const activateKeyBtn = document.getElementById('activate-key-btn');
const loadFileBtn = document.getElementById('load-file-btn');
const createFileBtn = document.getElementById('create-file-btn');
const messagesDiv = document.getElementById('messages');
const inputArea = document.getElementById('input-area');
const msgInput = document.getElementById('msg-input');
const sendBtn = document.getElementById('send-btn');
const fileInput = document.getElementById('file-input');
const notification = document.getElementById('notification');
const menuBtn = document.getElementById('menu-btn');
const menuPanel = document.getElementById('menu-panel');
const menuClose = document.getElementById('menu-close');
const killChatBtn = document.getElementById('kill-chat-btn');
const participantsCount = document.getElementById('participants-count');
const lastActivity = document.getElementById('last-activity');
const encryptionStatus = document.getElementById('encryption-status');
const clientIdSpan = document.getElementById('client-id');
const selfNameSpan = document.getElementById('self-name');

// === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
const utils = {
  generateRoomId: () => 'room-' + Math.random().toString(36).substring(2, 8),
  
  generateUniqueName: (clientId) => {
    const storedNames = utils.getStoredNames();
    if (storedNames[clientId]) {
      return storedNames[clientId];
    }
    
    let newName;
    let isUnique = false;
    
    while (!isUnique) {
      const color = nameColors[Math.floor(Math.random() * nameColors.length)];
      const animal = nameAnimals[Math.floor(Math.random() * nameAnimals.length)];
      newName = `${color} ${animal}`;
      
      isUnique = true;
      for (const [id, name] of state.participants) {
        if (name === newName && id !== clientId) {
          isUnique = false;
          break;
        }
      }
      
      if (isUnique) {
        for (const savedName of Object.values(storedNames)) {
          if (savedName === newName) {
            isUnique = false;
            break;
          }
        }
      }
    }
    
    storedNames[clientId] = newName;
    localStorage.setItem('secret-chat-names', JSON.stringify(storedNames));
    
    return newName;
  },
  
  getStoredNames: () => {
    const stored = localStorage.getItem('secret-chat-names');
    return stored ? JSON.parse(stored) : {};
  },
  
  formatTime: (timestamp) => {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('ru-RU', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: false
    });
  },
  
  updateStatus: (status, isSecure = false) => {
    document.getElementById('status-text').textContent = status;
    const connectionStatus = document.getElementById('connection-status');
    connectionStatus.className = 'status-dot';
    
    if (status.includes('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ')) {
      connectionStatus.classList.add('connected');
      if (isSecure) {
        connectionStatus.classList.add('secure');
      }
    }
  },
  
  showNotification: (message, type = 'info') => {
    notification.textContent = message;
    notification.className = `system-notification ${type}`;
    notification.classList.add('show');
    
    setTimeout(() => {
      notification.classList.remove('show');
    }, 3000);
  },
  
  addMessage: (text, isOwn, senderName, timestamp, isEncrypted = false) => {
    const msgDiv = document.createElement('div');
    msgDiv.className = `msg ${isOwn ? 'my' : 'theirs'}`;
    
    let html = `
      <span class="sender-name">${senderName}</span>
      <div class="message-content">${text}</div>
      <span class="message-time">${utils.formatTime(timestamp)}</span>
    `;
    
    if (isEncrypted && isOwn) {
      html += '<div class="encrypted-badge"></div>';
    }
    
    msgDiv.innerHTML = html;
    messagesDiv.appendChild(msgDiv);
    
    setTimeout(() => {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }, 50);
    
    lastActivity.textContent = utils.formatTime(timestamp);
    participantsCount.textContent = state.participants.size;
    selfNameSpan.textContent = state.selfName;
  },
  
  addSystemMessage: (text, type = 'normal') => {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'msg';
    msgDiv.style.backgroundColor = 'rgba(51, 65, 85, 0.5)';
    msgDiv.style.textAlign = 'center';
    msgDiv.style.borderRadius = '12px';
    msgDiv.style.color = type === 'secure' ? '#4ade80' : type === 'warning' ? '#fbbf24' : '#94a3b8';
    
    msgDiv.innerHTML = `
      <span class="message-time">${utils.formatTime(Date.now())}</span>
      <div class="message-content">${text}</div>
    `;
    
    messagesDiv.appendChild(msgDiv);
    
    setTimeout(() => {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }, 50);
  },
  
  saveSession: () => {
    if (!persistCheckbox.checked || !state.isConnected) {
      sessionStorage.removeItem('secret-chat-session');
      return;
    }
    
    sessionStorage.setItem('secret-chat-session', JSON.stringify({
      room: roomInput.value,
      selfName: state.selfName,
      participants: Object.fromEntries(state.participants),
      timestamp: Date.now()
    }));
  },
  
  loadSession: () => {
    const saved = sessionStorage.getItem('secret-chat-session');
    if (!saved) return false;
    
    try {
      const s = JSON.parse(saved);
      if (Date.now() - s.timestamp > 86400000) return false;
      
      roomInput.value = s.room;
      state.selfName = s.selfName;
      
      state.participants.clear();
      if (s.participants) {
        Object.entries(s.participants).forEach(([clientId, name]) => {
          state.participants.set(clientId, name);
        });
      }
      
      persistCheckbox.checked = true;
      return true;
    } catch (e) {
      return false;
    }
  },
  
  resetUI: () => {
    keyPanel.style.display = 'none';
    createFileBtn.style.display = 'none';
    inputArea.style.display = 'none';
    sendBtn.disabled = true;
    messagesDiv.innerHTML = '';
    roomInput.disabled = false;
    connectBtn.disabled = false;
    state.participants.clear();
    participantsCount.textContent = '0';
    encryptionStatus.textContent = '–ù–µ –∞–∫—Ç–∏–≤–Ω–æ';
    state.selfName = '';
    selfNameSpan.textContent = '-';
  },
  
  adjustInputHeight: () => {
    const input = msgInput;
    input.style.height = 'auto';
    if (input.scrollHeight > 100) {
      input.style.height = '100px';
    } else {
      input.style.height = (input.scrollHeight) + 'px';
    }
  }
};

// === –ö–†–ò–ü–¢–û–ì–†–ê–§–ò–ß–ï–°–ö–ò–ï –§–£–ù–ö–¶–ò–ò ===
const cryptoUtils = {
  generateRandomAESKey: () => {
    const arr = new Uint8Array(32);
    crypto.getRandomValues(arr);
    return Array.from(arr, b => b.toString(16).padStart(2, '0')).join('');
  },
  
  encryptMsg: async (plaintext) => {
    if (!state.aesKey) throw new Error('–ö–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encoded = new TextEncoder().encode(plaintext);
    try {
      const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, state.aesKey, encoded);
      const combined = new Uint8Array(iv.length + cipher.byteLength);
      combined.set(iv, 0);
      combined.set(new Uint8Array(cipher), iv.length);
      return 'ENC:' + btoa(String.fromCharCode.apply(null, combined));
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', e);
      throw new Error('–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è');
    }
  },
  
  decryptMsg: async (payload) => {
    if (!payload.startsWith('ENC:')) return '[–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç]';
    if (!state.aesKey) return '[–ö–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω]';
    
    try {
      const b64 = payload.slice(4);
      const combined = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
      const iv = combined.slice(0, 12);
      const ct = combined.slice(12);
      const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, state.aesKey, ct);
      return new TextDecoder().decode(decrypted);
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏:', e);
      return '[‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏]';
    }
  },
  
  deriveKeyFromPassphrase: async (passphrase, salt) => {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey(
      'raw',
      enc.encode(passphrase),
      'PBKDF2',
      false,
      ['deriveKey']
    );
    return crypto.subtle.deriveKey(
      { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
      keyMaterial,
      { name: 'AES-GCM', length: 256 },
      false,
      ['encrypt', 'decrypt']
    );
  },
  
  encryptFileData: async (data, passphrase) => {
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const aesKey = await cryptoUtils.deriveKeyFromPassphrase(passphrase, salt);
    const encoded = new TextEncoder().encode(data);
    const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, aesKey, encoded);
    const result = new Uint8Array(16 + 12 + cipher.byteLength);
    result.set(salt, 0);
    result.set(iv, 16);
    result.set(new Uint8Array(cipher), 28);
    return result;
  },
  
  decryptFileData: async (buffer, passphrase) => {
    const salt = buffer.slice(0, 16);
    const iv = buffer.slice(16, 28);
    const ct = buffer.slice(28);
    const aesKey = await cryptoUtils.deriveKeyFromPassphrase(passphrase, salt);
    const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, aesKey, ct);
    return new TextDecoder().decode(decrypted);
  },
  
  generateAESKey: async (hex) => {
    if (!/^[0-9a-fA-F]{64}$/.test(hex)) {
      throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 64 hex —Å–∏–º–≤–æ–ª–∞)');
    }
    
    try {
      const keyBuf = new Uint8Array(hex.match(/.{2}/g).map(byte => parseInt(byte, 16)));
      state.aesKey = await crypto.subtle.importKey(
        'raw',
        keyBuf.buffer,
        { name: 'AES-GCM' },
        false,
        ['encrypt', 'decrypt']
      );
      state.isKeySet = true;
      encryptionStatus.textContent = '–ê–∫—Ç–∏–≤–Ω–æ (AES-GCM)';
      utils.showNotification('‚úÖ –ö–ª—é—á —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!', 'secure');
      utils.addSystemMessage('üîí –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ. –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω—ã.', 'secure');
      return true;
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞:', e);
      throw new Error('–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–ª—é—á–∞');
    }
  }
};

// === –§–ê–ô–õ–û–í–´–ï –û–ü–ï–†–ê–¶–ò–ò ===
const fileUtils = {
  createChristmasFile: async () => {
    if (!state.isConnected || !state.isKeySet) {
      utils.showNotification('‚ùå –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –∫–ª—é—á –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞', 'danger');
      return;
    }

    const passphrase = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥–æ–≤—É—é —Ñ—Ä–∞–∑—É –¥–ª—è —Ñ–∞–π–ª–∞ (4‚Äì24 —Å–∏–º–≤–æ–ª–∞):');
    if (!passphrase || passphrase.length < 4 || passphrase.length > 24) {
      utils.showNotification('‚ùå –§—Ä–∞–∑–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 4 –¥–æ 24 —Å–∏–º–≤–æ–ª–æ–≤', 'danger');
      return;
    }

    try {
      const data = JSON.stringify({ 
        v: 1, 
        room: roomInput.value, 
        key: keyInput.value.trim(),
        clientId: state.clientId,
        selfName: state.selfName,
        timestamp: Date.now()
      });
      
      const encrypted = await cryptoUtils.encryptFileData(data, passphrase);
      const blob = new Blob([encrypted], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Christmas.by';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      utils.showNotification('‚úÖ –§–∞–π–ª Christmas.by —Å–æ–∑–¥–∞–Ω!', 'secure');
      utils.addSystemMessage('üîí –§–∞–π–ª —Å–æ–∑–¥–∞–Ω. –ü–µ—Ä–µ–¥–∞–π—Ç–µ –µ–≥–æ –∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—É –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.', 'secure');
    } catch (e) {
      utils.showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞', 'danger');
      console.error(e);
    }
  },
  
  loadChristmasFile: async (file) => {
    const arrayBuffer = await file.arrayBuffer();
    const passphrase = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥–æ–≤—É—é —Ñ—Ä–∞–∑—É –¥–ª—è —Ñ–∞–π–ª–∞ Christmas.by:');
    if (!passphrase) return;

    try {
      const decrypted = await cryptoUtils.decryptFileData(arrayBuffer, passphrase);
      const data = JSON.parse(decrypted);
      
      if (data.v !== 1 || !data.room || !/^[0-9a-fA-F]{64}$/.test(data.key)) {
        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
      }

      const { room, key, clientId, selfName } = data;
      
      state.selfName = selfName || utils.generateUniqueName(state.clientId);
      
      utils.showNotification('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!', 'secure');
      utils.addSystemMessage('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'secure');
      
      await chatUtils.connectToRoom(room);
      keyInput.value = key;
      await cryptoUtils.generateAESKey(key);
      state.isSecureConnection = true;
      
      if (clientId) {
        const creatorName = utils.generateUniqueName(clientId);
        state.participants.set(clientId, creatorName);
        utils.addSystemMessage(`üîí ${creatorName} ‚Äî —Å–æ–∑–¥–∞—Ç–µ–ª—å —Ñ–∞–π–ª–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)`, 'secure');
      }
      
    } catch (err) {
      utils.showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞', 'danger');
      utils.addSystemMessage(`‚ùå ${err.message || '–ù–µ–≤–µ—Ä–Ω–∞—è —Ñ—Ä–∞–∑–∞ –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–π —Ñ–∞–π–ª'}`, 'danger');
    }
  }
};

// === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ß–ê–¢–ê ===
const chatUtils = {
  initMQTT: () => {
    if (state.mqttClient) {
      state.mqttClient.end();
    }
    
    state.mqttClient = mqtt.connect('wss://broker.hivemq.com:8884/mqtt', {
      clientId: state.clientId,
      clean: true,
      reconnectPeriod: 3000,
      connectTimeout: 5000
    });
    
    state.mqttClient.on('connect', () => {
      console.log('MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω');
      state.mqttClient.subscribe(state.currentTopic, { qos: 1 });
      utils.updateStatus(`–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫: ${roomInput.value}`, state.isSecureConnection);
      
      setTimeout(() => {
        chatUtils.sendSystemMessage(`JOIN:${state.clientId}:${state.selfName}`);
      }, 500);
    });
    
    state.mqttClient.on('message', (topic, payload) => {
      if (topic !== state.currentTopic) return;
      
      try {
        const msg = payload.toString();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
        if (state.messageIds.has(msg)) {
          return;
        }
        
        state.messageIds.add(msg);
        
        if (msg.startsWith('SYS:')) {
          const parts = msg.split(':');
          if (parts[1] === 'JOIN') {
            const clientId = parts[2];
            const senderName = parts[3] || utils.generateUniqueName(clientId);
            
            if (clientId !== state.clientId) {
              state.participants.set(clientId, senderName);
              utils.addSystemMessage(`‚úÖ ${senderName} –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ —á–∞—Ç—É`, 'secure');
            }
          }
          return;
        }
        
        if (state.isKeySet) {
          const plain = await cryptoUtils.decryptMsg(msg);
          utils.addMessage(plain, false, '–ö–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç', Date.now());
        } else {
          utils.addMessage('[üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ]', false, '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π', Date.now());
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
      }
    });
    
    return state.mqttClient;
  },
  
  connectToRoom: (room) => {
    return new Promise((resolve) => {
      state.currentTopic = `sc-${room.replace(/\W/g, '_')}`;
      state.isConnected = true;
      
      roomInput.value = room;
      roomInput.disabled = true;
      connectBtn.disabled = true;
      keyPanel.style.display = 'flex';
      
      chatUtils.initMQTT();
      
      resolve();
    });
  },
  
  sendSystemMessage: (data) => {
    if (!state.mqttClient || !state.mqttClient.connected || !state.isConnected) {
      return;
    }
    
    state.mqttClient.publish(state.currentTopic, data, { qos: 1 });
  },
  
  send: async () => {
    if (!state.mqttClient || !state.mqttClient.connected) {
      utils.showNotification('‚ö†Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É...', 'warning');
      return;
    }
    
    if (!state.isConnected || !state.isKeySet) {
      utils.showNotification('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –∫–ª—é—á', 'danger');
      return;
    }
    
    const text = msgInput.value.trim();
    if (!text) return;
    
    const timestamp = Date.now();
    const messageId = `msg-${timestamp}-${Math.random().toString(36).substring(2, 8)}`;
    const messageData = `${state.selfName}:${text}:${messageId}`;
    
    try {
      const encrypted = await cryptoUtils.encryptMsg(messageData);
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
      if (state.messageIds.has(encrypted)) {
        return;
      }
      
      state.messageIds.add(encrypted);
      
      state.mqttClient.publish(state.currentTopic, encrypted, { qos: 1 });
      
      utils.addMessage(text, true, state.selfName, timestamp, true);
      
      msgInput.value = '';
      msgInput.style.height = 'auto';
      state.lastMessageTime = timestamp;
      utils.saveSession();
      
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', e);
      utils.showNotification(`‚ùå ${e.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'}`, 'danger');
    }
  },
  
  resetChat: () => {
    if (state.isConnected && state.currentTopic && state.mqttClient?.connected) {
      chatUtils.sendSystemMessage('SYS:WIPE');
    }
    
    if (state.mqttClient) {
      state.mqttClient.end();
    }
    
    state.aesKey = null;
    state.isConnected = false;
    state.isKeySet = false;
    state.isSecureConnection = false;
    state.participants.clear();
    state.messageHistory = [];
    state.lastMessageTime = 0;
    state.messageIds.clear();
    
    utils.resetUI();
    persistCheckbox.checked = false;
    sessionStorage.removeItem('secret-chat-session');
    localStorage.removeItem('secret-chat-names');
    
    roomInput.value = utils.generateRoomId();
    roomInput.disabled = false;
    connectBtn.disabled = false;
    clientIdSpan.textContent = state.clientId.substring(0, 12) + '...';
    
    utils.updateStatus('–ß–∞—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω. –ù–∞—á–∞—Ç–∞ –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è');
    utils.showNotification('‚úÖ –ß–∞—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω', 'secure');
  }
};

// === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
const init = () => {
  if (!window.crypto || !window.crypto.subtle) {
    alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—é. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome, Firefox –∏–ª–∏ Edge.');
    return;
  }
  
  state.selfName = utils.generateUniqueName(state.clientId);
  selfNameSpan.textContent = state.selfName;
  clientIdSpan.textContent = state.clientId.substring(0, 12) + '...';
  
  msgInput.addEventListener('input', utils.adjustInputHeight);
  msgInput.addEventListener('focus', utils.adjustInputHeight);
  
  if (!utils.loadSession()) {
    roomInput.value = utils.generateRoomId();
  }
  
  utils.updateStatus('–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é');
};

// === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ===
document.addEventListener('DOMContentLoaded', () => {
  init();
  
  connectBtn.onclick = () => {
    const room = roomInput.value.trim();
    if (!room) {
      utils.showNotification('‚ùå –£–∫–∞–∂–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã', 'danger');
      return;
    }
    chatUtils.connectToRoom(room);
    utils.saveSession();
  };
  
  generateKeyBtn.onclick = () => {
    keyInput.value = cryptoUtils.generateRandomAESKey();
    utils.showNotification('‚úÖ –ö–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!', 'secure');
  };
  
  activateKeyBtn.onclick = async () => {
    const hex = keyInput.value.trim();
    if (!hex) {
      utils.showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á', 'danger');
      return;
    }
    
    try {
      await cryptoUtils.generateAESKey(hex);
      keyPanel.style.display = 'none';
      inputArea.style.display = 'flex';
      sendBtn.disabled = false;
      createFileBtn.style.display = 'block';
      
      setTimeout(() => {
        msgInput.focus();
        utils.adjustInputHeight();
      }, 300);
      
      chatUtils.sendSystemMessage(`SYS:JOIN:${state.clientId}:${state.selfName}`);
    } catch (e) {
      utils.showNotification(`‚ùå ${e.message}`, 'danger');
    }
  };
  
  loadFileBtn.onclick = () => {
    fileInput.click();
  };
  
  fileInput.onchange = (e) => {
    const file = e.target.files[0];
    if (file && file.name.endsWith('.by')) {
      fileUtils.loadChristmasFile(file);
      fileInput.value = '';
    } else {
      utils.showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .by', 'danger');
    }
  };
  
  createFileBtn.onclick = fileUtils.createChristmasFile;
  
  sendBtn.onclick = chatUtils.send;
  
  msgInput.onkeypress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      chatUtils.send();
    }
  };
  
  menuBtn.onclick = () => {
    menuPanel.classList.add('open');
  };
  
  menuClose.onclick = () => {
    menuPanel.classList.remove('open');
  };
  
  killChatBtn.onclick = () => {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç —á–∞—Ç –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!')) {
      chatUtils.resetChat();
      menuPanel.classList.remove('open');
    }
  };
  
  document.addEventListener('click', (e) => {
    if (menuPanel.classList.contains('open') && 
        !menuPanel.contains(e.target) && 
        e.target !== menuBtn && 
        e.target !== menuClose) {
      menuPanel.classList.remove('open');
    }
  });
});

// === –ü–†–û–í–ï–†–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø ===
setInterval(() => {
  if (state.mqttClient && !state.mqttClient.connected && state.isConnected) {
    utils.updateStatus('‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ', false);
  }
}, 5000);
</script>
</body>
</html>
