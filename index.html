<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üîí –°–µ–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Ç</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #1e293b;
      --dark: #0f172a;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --light: #f1f5f9;
      --gray: #64748b;
      --border: #334155;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--dark);
      color: var(--light);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 8px;
    }
    #chat-container {
      background: var(--secondary);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    /* –®–∞–ø–∫–∞ —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º */
    #header {
      padding: 12px 16px;
      background: rgba(30, 41, 59, 0.8);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--warning);
    }
    .status-dot.connected {
      background: var(--success);
    }
    .status-dot.secure {
      background: var(--success);
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
    }
    /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    #control-panel {
      padding: 12px;
      background: var(--dark);
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .control-group {
      display: flex;
      gap: 8px;
      flex: 1;
      min-width: 200px;
    }
    /* –ü–∞–Ω–µ–ª—å –∫–ª—é—á–µ–π */
    #key-panel {
      padding: 12px;
      background: rgba(99, 102, 241, 0.1);
      border-bottom: 1px solid var(--primary);
      display: none;
    }
    #key-input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #1e293b;
      color: var(--light);
      font-family: monospace;
      font-size: 14px;
      min-width: 150px;
    }
    /* –°–æ–æ–±—â–µ–Ω–∏—è */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .msg {
      max-width: 85%;
      padding: 14px;
      border-radius: 16px;
      position: relative;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .my { 
      background: var(--primary); 
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .theirs { 
      background: var(--dark); 
      border-bottom-left-radius: 4px;
    }
    .sender-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      display: block;
    }
    .my .sender-name { color: #dbeafe; }
    .theirs .sender-name { color: #cbd5e1; }
    .message-content {
      line-height: 1.5;
      word-break: break-word;
    }
    .message-time {
      font-size: 12px;
      color: var(--gray);
      margin-top: 4px;
      display: block;
      text-align: right;
    }
    .my .message-time { color: #93c5fd; }
    .theirs .message-time { color: #94a3b8; }
    .encrypted-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 18px;
      height: 18px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffffff'%3E%3Cpath d='M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
    }
    /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ */
    #input-area {
      padding: 12px;
      background: var(--dark);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
    }
    #msg-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #1e293b;
      color: var(--light);
      font-family: 'Inter', sans-serif;
      font-size: 16px;
    }
    #send-btn {
      padding: 0 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    #send-btn:hover {
      background: var(--primary-dark);
    }
    #send-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    /* –ü–∞–Ω–µ–ª—å —Ñ–∞–π–ª–æ–≤ */
    #file-panel {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: rgba(30, 41, 59, 0.5);
      border-top: 1px solid var(--border);
    }
    .file-btn {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px dashed var(--border);
      background: transparent;
      color: var(--gray);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .file-btn:hover {
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
      border-color: var(--primary);
    }
    /* –°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .system-notification {
      position: fixed;
      top: 16px;
      right: 16px;
      max-width: 300px;
      padding: 12px 16px;
      border-radius: 12px;
      color: white;
      font-size: 14px;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transform: translateY(-100px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .system-notification.show {
      transform: translateY(0);
      opacity: 1;
    }
    .system-notification.secure {
      background: rgba(16, 185, 129, 0.9);
    }
    .system-notification.warning {
      background: rgba(245, 158, 11, 0.9);
    }
    .system-notification.danger {
      background: rgba(239, 68, 68, 0.9);
    }
    /* –ö–Ω–æ–ø–∫–∏ */
    .btn {
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--light);
    }
    .btn-secondary:hover {
      background: rgba(255,255,255,0.05);
    }
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    .btn-danger:hover {
      opacity: 0.9;
    }
    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }
    .btn-warning:hover {
      opacity: 0.9;
    }
    /* –ú–µ–Ω—é */
    #menu-panel {
      position: fixed;
      top: 0;
      right: -300px;
      width: 280px;
      height: 100vh;
      background: var(--secondary);
      border-left: 1px solid var(--border);
      padding: 20px;
      transition: right 0.3s ease;
      z-index: 100;
      box-shadow: -2px 0 10px rgba(0,0,0,0.3);
    }
    #menu-panel.open {
      right: 0;
    }
    .menu-item {
      padding: 12px 16px;
      border-radius: 8px;
      margin: 8px 0;
      cursor: pointer;
      transition: all 0.2s;
    }
    .menu-item:hover {
      background: rgba(99, 102, 241, 0.1);
    }
    .menu-item.danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }
    .menu-item.danger:hover {
      background: rgba(239, 68, 68, 0.2);
    }
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 480px) {
      .control-group {
        min-width: 100%;
      }
      #input-area {
        flex-direction: column;
      }
      #msg-input {
        width: 100%;
      }
      .file-btn {
        padding: 14px;
      }
      #menu-panel {
        width: 100%;
      }
      #key-input {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>

<div id="chat-container">
  <div id="header">
    <div class="status-indicator">
      <div class="status-dot" id="connection-status"></div>
      <span id="status-text">–ù–µ –ø–æ–¥–∫–ª—é—á—ë–Ω</span>
    </div>
    <div>
      <button class="btn btn-secondary" id="menu-btn">‚ò∞</button>
    </div>
  </div>

  <div id="control-panel">
    <div class="control-group">
      <input type="text" id="room-id" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" class="btn-secondary">
      <button class="btn btn-primary" id="connect-btn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    </div>
    <div class="control-group">
      <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
        <input type="checkbox" id="persist-checkbox">
        <span>–ó–∞–ø–æ–º–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é</span>
      </label>
    </div>
  </div>

  <div id="key-panel">
    <div class="control-group">
      <input type="text" id="key-input" placeholder="AES-256 –∫–ª—é—á (64 hex —Å–∏–º–≤–æ–ª–∞)" maxlength="64">
      <button class="btn btn-warning" id="generate-key-btn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
      <button class="btn btn-primary" id="activate-key-btn">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>

  <div id="file-panel">
    <div class="file-btn" id="load-file-btn">
      üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å Christmas.by
    </div>
    <div class="file-btn" id="create-file-btn" style="display: none;">
      üíæ –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª
    </div>
  </div>

  <div id="messages">
    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
  </div>

  <div id="input-area" style="display: none;">
    <input type="text" id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
    <button id="send-btn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

<input type="file" id="file-input" accept=".by" style="display: none;">

<!-- –°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div class="system-notification" id="notification"></div>

<!-- –ú–µ–Ω—é -->
<div id="menu-panel">
  <h3 style="margin-bottom: 20px; color: var(--light);">–ú–µ–Ω—é</h3>
  <div class="menu-item" id="kill-chat-btn">
    üóëÔ∏è KILL-CHAT (–ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞)
  </div>
  <div class="menu-item">
    üìã –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: <span id="participants-count">0</span>
  </div>
  <div class="menu-item">
    ‚è∞ –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: <span id="last-activity">-</span>
  </div>
  <div class="menu-item">
    üîë –°—Ç–∞—Ç—É—Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: <span id="encryption-status">–ù–µ –∞–∫—Ç–∏–≤–Ω–æ</span>
  </div>
  <div class="menu-item">
    üíª –ú–æ–π ID: <span id="client-id">${state.clientId.substring(0, 8)}...</span>
  </div>
  <div class="menu-item">
    üë§ –ú–æ—ë –∏–º—è: <span id="self-name">-</span>
  </div>
</div>

<script>
// === –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ===
const state = {
  currentTopic: null,
  aesKey: null,
  isConnected: false,
  isKeySet: false,
  isSecureConnection: false,
  clientId: 'client-' + Math.random().toString(36).substring(2, 10),
  selfName: '',
  participants: new Map(), // clientId -> name
  lastMessageTime: 0,
  sentMessages: new Set(),
  messageHistory: []
};

// === –°–ü–ò–°–ö–ò –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –ò–ú–Å–ù ===
const nameColors = ['–°–∏–Ω–∏–π', '–ö—Ä–∞—Å–Ω—ã–π', '–ó–µ–ª—ë–Ω—ã–π', '–ñ—ë–ª—Ç—ã–π', '–§–∏–æ–ª–µ—Ç–æ–≤—ã–π', '–û—Ä–∞–Ω–∂–µ–≤—ã–π', '–†–æ–∑–æ–≤—ã–π', '–ì–æ–ª—É–±–æ–π', '–°–µ—Ä—ã–π', '–ë–∏—Ä—é–∑–æ–≤—ã–π', '–ò–Ω–¥–∏–≥–æ', '–ë–æ—Ä–¥–æ–≤—ã–π', '–ë—Ä–æ–Ω–∑–æ–≤—ã–π', '–°–µ—Ä–µ–±—Ä—è–Ω—ã–π', '–ó–æ–ª–æ—Ç–æ–π', '–•–∞–∫–∏', '–ú—è—Ç–Ω—ã–π', '–õ–∞–≤–∞–Ω–¥–æ–≤—ã–π', '–ë–µ–∂–µ–≤—ã–π', '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π'];
const nameAnimals = ['–í–æ–ª–∫', '–õ–∏—Å–∞', '–°–æ–≤–∞', '–Ø—Å—Ç—Ä–µ–±', '–¢–∏–≥—Ä', '–ú–µ–¥–≤–µ–¥—å', '–õ–µ–æ–ø–∞—Ä–¥', '–û—Ä—ë–ª', '–î—Ä–∞–∫–æ–Ω', '–§–µ–Ω–∏–∫—Å', '–õ–µ–≤', '–ó–º–µ—è', '–ö–æ—Ç', '–ü—ë—Å', '–ö—Ä–æ–ª–∏–∫', '–õ–æ—à–∞–¥—å', '–°–ª–æ–Ω', '–û–±–µ–∑—å—è–Ω–∞', '–ü–∞–Ω–¥–∞', '–ö—Ä–æ–∫–æ–¥–∏–ª', '–ß–µ—Ä–µ–ø–∞—Ö–∞', '–ö–∏—Ç', '–ê–∫—É–ª–∞', '–û—Å—å–º–∏–Ω–æ–≥', '–°–æ–∫–æ–ª', '–í–æ—Ä–æ–Ω', '–õ–æ—Å—å', '–Å–∂'];

// === DOM –≠–õ–ï–ú–ï–ù–¢–´ ===
const elements = {
  connectionStatus: document.getElementById('connection-status'),
  statusText: document.getElementById('status-text'),
  roomInput: document.getElementById('room-id'),
  connectBtn: document.getElementById('connect-btn'),
  persistCheckbox: document.getElementById('persist-checkbox'),
  keyPanel: document.getElementById('key-panel'),
  keyInput: document.getElementById('key-input'),
  generateKeyBtn: document.getElementById('generate-key-btn'),
  activateKeyBtn: document.getElementById('activate-key-btn'),
  loadFileBtn: document.getElementById('load-file-btn'),
  createFileBtn: document.getElementById('create-file-btn'),
  messagesDiv: document.getElementById('messages'),
  inputArea: document.getElementById('input-area'),
  msgInput: document.getElementById('msg-input'),
  sendBtn: document.getElementById('send-btn'),
  fileInput: document.getElementById('file-input'),
  notification: document.getElementById('notification'),
  menuBtn: document.getElementById('menu-btn'),
  menuPanel: document.getElementById('menu-panel'),
  killChatBtn: document.getElementById('kill-chat-btn'),
  participantsCount: document.getElementById('participants-count'),
  lastActivity: document.getElementById('last-activity'),
  encryptionStatus: document.getElementById('encryption-status'),
  clientIdSpan: document.getElementById('client-id'),
  selfNameSpan: document.getElementById('self-name')
};

// === MQTT –ö–õ–ò–ï–ù–¢ ===
const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt', {
  clientId: state.clientId,
  clean: true
});

// === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
const utils = {
  generateRoomId: () => 'room-' + Math.random().toString(36).substring(2, 8),
  
  generateUniqueName: (clientId) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage
    const storedNames = utils.getStoredNames();
    if (storedNames[clientId]) {
      return storedNames[clientId];
    }
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
    let newName;
    let isUnique = false;
    
    while (!isUnique) {
      const color = nameColors[Math.floor(Math.random() * nameColors.length)];
      const animal = nameAnimals[Math.floor(Math.random() * nameAnimals.length)];
      newName = `${color} ${animal}`;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
      isUnique = true;
      for (const [id, name] of state.participants) {
        if (name === newName && id !== clientId) {
          isUnique = false;
          break;
        }
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–µ–¥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–º–µ–Ω
      if (isUnique) {
        for (const savedName of Object.values(storedNames)) {
          if (savedName === newName) {
            isUnique = false;
            break;
          }
        }
      }
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    storedNames[clientId] = newName;
    localStorage.setItem('secret-chat-names', JSON.stringify(storedNames));
    
    return newName;
  },
  
  getStoredNames: () => {
    const stored = localStorage.getItem('secret-chat-names');
    return stored ? JSON.parse(stored) : {};
  },
  
  formatTime: (timestamp) => {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('ru-RU', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: false
    });
  },
  
  updateStatus: (status, isSecure = false) => {
    elements.statusText.textContent = status;
    elements.connectionStatus.className = 'status-dot';
    
    if (status.includes('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ')) {
      elements.connectionStatus.classList.add('connected');
      if (isSecure) {
        elements.connectionStatus.classList.add('secure');
      }
    }
  },
  
  showNotification: (message, type = 'info') => {
    elements.notification.textContent = message;
    elements.notification.className = `system-notification ${type}`;
    elements.notification.classList.add('show');
    
    setTimeout(() => {
      elements.notification.classList.remove('show');
    }, 3000);
  },
  
  addMessage: (text, isOwn, senderName, timestamp, isEncrypted = false) => {
    const msgDiv = document.createElement('div');
    msgDiv.className = `msg ${isOwn ? 'my' : 'theirs'}`;
    
    let html = `
      <span class="sender-name">${senderName}</span>
      <div class="message-content">${text}</div>
      <span class="message-time">${utils.formatTime(timestamp)}</span>
    `;
    
    if (isEncrypted && isOwn) {
      html += '<div class="encrypted-badge"></div>';
    }
    
    msgDiv.innerHTML = html;
    elements.messagesDiv.appendChild(msgDiv);
    elements.messagesDiv.scrollTop = elements.messagesDiv.scrollHeight;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    elements.lastActivity.textContent = utils.formatTime(timestamp);
    elements.participantsCount.textContent = state.participants.size;
    elements.selfNameSpan.textContent = state.selfName;
  },
  
  addSystemMessage: (text, type = 'normal') => {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'msg';
    msgDiv.style.backgroundColor = 'rgba(51, 65, 85, 0.5)';
    msgDiv.style.textAlign = 'center';
    msgDiv.style.borderRadius = '12px';
    msgDiv.style.color = type === 'secure' ? '#4ade80' : type === 'warning' ? '#fbbf24' : '#94a3b8';
    
    msgDiv.innerHTML = `
      <span class="message-time">${utils.formatTime(Date.now())}</span>
      <div class="message-content">${text}</div>
    `;
    
    elements.messagesDiv.appendChild(msgDiv);
    elements.messagesDiv.scrollTop = elements.messagesDiv.scrollHeight;
  },
  
  saveSession: () => {
    if (!elements.persistCheckbox.checked || !state.isConnected) {
      sessionStorage.removeItem('secret-chat-session');
      return;
    }
    
    sessionStorage.setItem('secret-chat-session', JSON.stringify({
      room: elements.roomInput.value,
      selfName: state.selfName,
      participants: Object.fromEntries(state.participants),
      timestamp: Date.now()
    }));
  },
  
  loadSession: () => {
    const saved = sessionStorage.getItem('secret-chat-session');
    if (!saved) return false;
    
    try {
      const s = JSON.parse(saved);
      if (Date.now() - s.timestamp > 86400000) return false;
      
      elements.roomInput.value = s.room;
      state.selfName = s.selfName;
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
      state.participants.clear();
      if (s.participants) {
        Object.entries(s.participants).forEach(([clientId, name]) => {
          state.participants.set(clientId, name);
        });
      }
      
      elements.persistCheckbox.checked = true;
      return true;
    } catch (e) {
      return false;
    }
  },
  
  resetUI: () => {
    elements.keyPanel.style.display = 'none';
    elements.createFileBtn.style.display = 'none';
    elements.inputArea.style.display = 'none';
    elements.sendBtn.disabled = true;
    elements.messagesDiv.innerHTML = '';
    elements.roomInput.disabled = false;
    elements.connectBtn.disabled = false;
    state.participants.clear();
    elements.participantsCount.textContent = '0';
    elements.encryptionStatus.textContent = '–ù–µ –∞–∫—Ç–∏–≤–Ω–æ';
    state.selfName = '';
    elements.selfNameSpan.textContent = '-';
  }
};

// === –ö–†–ò–ü–¢–û–ì–†–ê–§–ò–ß–ï–°–ö–ò–ï –§–£–ù–ö–¶–ò–ò ===
const cryptoUtils = {
  generateRandomAESKey: () => {
    const arr = new Uint8Array(32); // 256 –±–∏—Ç
    crypto.getRandomValues(arr);
    return Array.from(arr, b => b.toString(16).padStart(2, '0')).join('');
  },
  
  encryptMsg: async (plaintext) => {
    if (!state.aesKey) throw new Error('–ö–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encoded = new TextEncoder().encode(plaintext);
    const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, state.aesKey, encoded);
    const combined = new Uint8Array(iv.length + cipher.byteLength);
    combined.set(iv, 0);
    combined.set(new Uint8Array(cipher), iv.length);
    return 'ENC:' + btoa(String.fromCharCode.apply(null, combined));
  },
  
  decryptMsg: async (payload) => {
    if (!payload.startsWith('ENC:')) return '[–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç]';
    if (!state.aesKey) return '[–ö–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω]';
    
    try {
      const b64 = payload.slice(4);
      const combined = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
      const iv = combined.slice(0, 12);
      const ct = combined.slice(12);
      const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, state.aesKey, ct);
      return new TextDecoder().decode(decrypted);
    } catch (e) {
      return '[‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏]';
    }
  },
  
  deriveKeyFromPassphrase: async (passphrase, salt) => {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey(
      'raw',
      enc.encode(passphrase),
      'PBKDF2',
      false,
      ['deriveKey']
    );
    return crypto.subtle.deriveKey(
      { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
      keyMaterial,
      { name: 'AES-GCM', length: 256 },
      false,
      ['encrypt', 'decrypt']
    );
  },
  
  encryptFileData: async (data, passphrase) => {
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const aesKey = await cryptoUtils.deriveKeyFromPassphrase(passphrase, salt);
    const encoded = new TextEncoder().encode(data);
    const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, aesKey, encoded);
    const result = new Uint8Array(16 + 12 + cipher.byteLength);
    result.set(salt, 0);
    result.set(iv, 16);
    result.set(new Uint8Array(cipher), 28);
    return result;
  },
  
  decryptFileData: async (buffer, passphrase) => {
    const salt = buffer.slice(0, 16);
    const iv = buffer.slice(16, 28);
    const ct = buffer.slice(28);
    const aesKey = await cryptoUtils.deriveKeyFromPassphrase(passphrase, salt);
    const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, aesKey, ct);
    return new TextDecoder().decode(decrypted);
  },
  
  generateAESKey: async (hex) => {
    if (!/^[0-9a-fA-F]{64}$/.test(hex)) {
      throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 64 hex —Å–∏–º–≤–æ–ª–∞)');
    }
    
    const keyBuf = new Uint8Array(hex.match(/.{2}/g).map(byte => parseInt(byte, 16)));
    state.aesKey = await crypto.subtle.importKey(
      'raw',
      keyBuf.buffer,
      { name: 'AES-GCM' },
      false,
      ['encrypt', 'decrypt']
    );
    state.isKeySet = true;
    elements.encryptionStatus.textContent = '–ê–∫—Ç–∏–≤–Ω–æ (AES-GCM)';
    utils.showNotification('‚úÖ –ö–ª—é—á —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!', 'secure');
    utils.addSystemMessage('üîí –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ. –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω—ã.', 'secure');
  }
};

// === –§–ê–ô–õ–û–í–´–ï –û–ü–ï–†–ê–¶–ò–ò ===
const fileUtils = {
  createChristmasFile: async () => {
    if (!state.isConnected || !state.isKeySet) {
      utils.showNotification('‚ùå –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –∫–ª—é—á –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞', 'danger');
      return;
    }

    const passphrase = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥–æ–≤—É—é —Ñ—Ä–∞–∑—É –¥–ª—è —Ñ–∞–π–ª–∞ (4‚Äì24 —Å–∏–º–≤–æ–ª–∞):');
    if (!passphrase || passphrase.length < 4 || passphrase.length > 24) {
      utils.showNotification('‚ùå –§—Ä–∞–∑–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 4 –¥–æ 24 —Å–∏–º–≤–æ–ª–æ–≤', 'danger');
      return;
    }

    try {
      const data = JSON.stringify({ 
        v: 1, 
        room: elements.roomInput.value, 
        key: elements.keyInput.value.trim(),
        clientId: state.clientId,
        selfName: state.selfName,
        timestamp: Date.now()
      });
      
      const encrypted = await cryptoUtils.encryptFileData(data, passphrase);
      const blob = new Blob([encrypted], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Christmas.by';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      utils.showNotification('‚úÖ –§–∞–π–ª Christmas.by —Å–æ–∑–¥–∞–Ω!', 'secure');
      utils.addSystemMessage('üîí –§–∞–π–ª —Å–æ–∑–¥–∞–Ω. –ü–µ—Ä–µ–¥–∞–π—Ç–µ –µ–≥–æ –∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—É –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.', 'secure');
    } catch (e) {
      utils.showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞', 'danger');
      console.error(e);
    }
  },
  
  loadChristmasFile: async (file) => {
    const arrayBuffer = await file.arrayBuffer();
    const passphrase = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥–æ–≤—É—é —Ñ—Ä–∞–∑—É –¥–ª—è —Ñ–∞–π–ª–∞ Christmas.by:');
    if (!passphrase) return;

    try {
      const decrypted = await cryptoUtils.decryptFileData(arrayBuffer, passphrase);
      const data = JSON.parse(decrypted);
      
      if (data.v !== 1 || !data.room || !/^[0-9a-fA-F]{64}$/.test(data.key)) {
        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      const { room, key, clientId, selfName } = data;
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
      state.selfName = selfName || utils.generateUniqueName(state.clientId);
      
      utils.showNotification('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!', 'secure');
      utils.addSystemMessage('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'secure');
      
      // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
      await chatUtils.connectToRoom(room);
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª—é—á
      elements.keyInput.value = key;
      await cryptoUtils.generateAESKey(key);
      state.isSecureConnection = true;
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–∑–¥–∞—Ç–µ–ª—è —Ñ–∞–π–ª–∞ –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞
      if (clientId) {
        const creatorName = utils.generateUniqueName(clientId);
        state.participants.set(clientId, creatorName);
        utils.addSystemMessage(`üîí ${creatorName} ‚Äî —Å–æ–∑–¥–∞—Ç–µ–ª—å —Ñ–∞–π–ª–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)`, 'secure');
      }
      
    } catch (err) {
      utils.showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞', 'danger');
      utils.addSystemMessage(`‚ùå ${err.message || '–ù–µ–≤–µ—Ä–Ω–∞—è —Ñ—Ä–∞–∑–∞ –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–π —Ñ–∞–π–ª'}`, 'danger');
    }
  }
};

// === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ß–ê–¢–ê ===
const chatUtils = {
  connectToRoom: (room) => {
    return new Promise((resolve) => {
      if (state.isConnected) {
        client.unsubscribe(state.currentTopic);
      }
      
      state.currentTopic = `telemetry/${room.replace(/\W/g, '_')}`;
      client.subscribe(state.currentTopic);
      state.isConnected = true;
      
      elements.roomInput.value = room;
      elements.roomInput.disabled = true;
      elements.connectBtn.disabled = true;
      elements.keyPanel.style.display = 'flex';
      elements.createFileBtn.style.display = 'none';
      
      utils.updateStatus(`–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ${room}`, state.isSecureConnection);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
      setTimeout(() => {
        chatUtils.sendSystemMessage(`JOIN:${state.clientId}:${state.selfName}`);
      }, 500);
      
      resolve();
    });
  },
  
  sendSystemMessage: async (data) => {
    if (!state.isConnected) return;
    
    const telemetry = {
      device_id: state.clientId,
      ts: Date.now(),
      data: data,
      v: 1,
      type: 'event'
    };
    
    client.publish(state.currentTopic, JSON.stringify(telemetry), { qos: 1 });
  },
  
  send: async () => {
    if (!state.isConnected || !state.isKeySet) return;
    
    const text = elements.msgInput.value.trim();
    if (!text) return;
    
    const timestamp = Date.now();
    const messageId = `${timestamp}-${Math.random().toString(36).substring(2, 8)}`;
    const fullMessage = `${text}:${messageId}:${state.selfName}`;
    
    try {
      const encrypted = await cryptoUtils.encryptMsg(fullMessage);
      const messageHash = btoa(fullMessage);
      
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É
      utils.addMessage(text, true, state.selfName, timestamp, true);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ MQTT
      const telemetry = {
        device_id: state.clientId,
        ts: timestamp,
        data: encrypted,
        v: 1,
        type: 'message',
        unit: 'C'
      };
      
      client.publish(state.currentTopic, JSON.stringify(telemetry), { qos: 1 });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
      state.messageHistory.push({
        raw: encrypted,
        timestamp: timestamp,
        sender: state.selfName,
        isOwn: true
      });
      
      elements.msgInput.value = '';
      state.lastMessageTime = timestamp;
      utils.saveSession();
      
    } catch (e) {
      utils.showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'danger');
      console.error(e);
    }
  },
  
  handleIncomingMessage: async (telemetry) => {
    if (Date.now() - telemetry.ts > 86400000) return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    
    // –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    if (telemetry.type === 'event') {
      if (telemetry.data.startsWith('JOIN:')) {
        const [_, clientId, senderName] = telemetry.data.split(':');
        
        if (clientId !== state.clientId) {
          let participantName;
          
          if (senderName) {
            participantName = senderName;
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
            if (Array.from(state.participants.values()).includes(participantName)) {
              participantName = utils.generateUniqueName(clientId);
            }
          } else {
            participantName = utils.generateUniqueName(clientId);
          }
          
          state.participants.set(clientId, participantName);
          
          const isSecure = state.isSecureConnection || (clientId === state.clientId);
          
          if (isSecure) {
            utils.addSystemMessage(`üîí ${participantName} –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è (–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)`, 'secure');
          } else {
            utils.addSystemMessage(`‚ö† ${participantName} –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è (–°–û–ï–î–ò–ù–ï–ù–ò–ï –ù–ï –ë–ï–ó–û–ü–ê–°–ù–û!)`, 'warning');
          }
        }
        return;
      }
      
      if (telemetry.data === 'WIPE') {
        utils.addSystemMessage('üßπ –ß–∞—Ç –±—ã–ª –æ—á–∏—â–µ–Ω —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º', 'warning');
        state.messageHistory = [];
        elements.messagesDiv.innerHTML = '';
        return;
      }
    }
    
    // –û–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    if (telemetry.type === 'message' && telemetry.data.startsWith('ENC:')) {
      const encrypted = telemetry.data;
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
      if (state.lastMessageTime >= telemetry.ts) return;
      
      if (state.isKeySet) {
        try {
          const fullText = await cryptoUtils.decryptMsg(encrypted);
          const [text, messageId, senderName] = fullText.split(':');
          
          if (text) {
            const isOwn = senderName === state.selfName;
            const displayName = senderName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
            
            utils.addMessage(text, isOwn, displayName, telemetry.ts, true);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            state.messageHistory.push({
              raw: encrypted,
              timestamp: telemetry.ts,
              sender: displayName,
              isOwn: isOwn
            });
          }
        } catch (e) {
          utils.addMessage('[‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏]', false, '–°–∏—Å—Ç–µ–º–∞', telemetry.ts);
        }
      } else {
        utils.addMessage('[üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ]', false, '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π', telemetry.ts);
      }
      
      state.lastMessageTime = telemetry.ts;
      utils.saveSession();
    }
  },
  
  resetChat: () => {
    if (state.isConnected && state.currentTopic) {
      chatUtils.sendSystemMessage('WIPE');
    }
    
    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
    state.aesKey = null;
    state.isConnected = false;
    state.isKeySet = false;
    state.isSecureConnection = false;
    state.participants.clear();
    state.messageHistory = [];
    state.lastMessageTime = 0;
    state.sentMessages.clear();
    
    // –°–±—Ä–æ—Å UI
    utils.resetUI();
    elements.persistCheckbox.checked = false;
    sessionStorage.removeItem('secret-chat-session');
    
    // –°–±—Ä–æ—Å –∏–º–µ–Ω
    localStorage.removeItem('secret-chat-names');
    
    // –ù–æ–≤—ã–π ID –∫–æ–º–Ω–∞—Ç—ã
    elements.roomInput.value = utils.generateRoomId();
    utils.updateStatus('–ß–∞—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω. –ù–∞—á–∞—Ç–∞ –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è');
    utils.showNotification('‚úÖ –ß–∞—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω', 'secure');
    
    // –û—á–∏—Å—Ç–∫–∞ MQTT
    if (state.currentTopic) {
      client.unsubscribe(state.currentTopic);
      state.currentTopic = null;
    }
  }
};

// === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
const init = () => {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏
  if (!window.crypto || !window.crypto.subtle) {
    alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—é. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome, Firefox –∏–ª–∏ Edge.');
    return;
  }
  
  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–º–µ–Ω–∏
  state.selfName = utils.generateUniqueName(state.clientId);
  elements.selfNameSpan.textContent = state.selfName;
  elements.clientIdSpan.textContent = state.clientId.substring(0, 8) + '...';
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏
  if (!utils.loadSession()) {
    elements.roomInput.value = utils.generateRoomId();
  }
  
  utils.updateStatus('–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é');
  
  // MQTT —Å–æ–±—ã—Ç–∏—è
  client.on('connect', () => {
    console.log('MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω');
  });
  
  client.on('message', (topic, payload) => {
    if (topic !== state.currentTopic || !state.isConnected) return;
    
    try {
      const telemetry = JSON.parse(payload.toString());
      chatUtils.handleIncomingMessage(telemetry);
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
    }
  });
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–∫–∏
  window.addEventListener('beforeunload', () => {
    if (state.isConnected && state.currentTopic) {
      chatUtils.sendSystemMessage(`LEAVE:${state.clientId}`);
    }
  });
};

// === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ===
document.addEventListener('DOMContentLoaded', () => {
  init();
  
  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ ID –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  if (!elements.roomInput.value) {
    elements.roomInput.value = utils.generateRoomId();
  }
  
  // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
  elements.connectBtn.onclick = () => {
    const room = elements.roomInput.value.trim();
    if (!room) {
      utils.showNotification('‚ùå –£–∫–∞–∂–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã', 'danger');
      return;
    }
    chatUtils.connectToRoom(room);
    utils.saveSession();
  };
  
  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞
  elements.generateKeyBtn.onclick = () => {
    elements.keyInput.value = cryptoUtils.generateRandomAESKey();
    utils.showNotification('‚úÖ –ö–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!', 'secure');
  };
  
  // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–ª—é—á–∞
  elements.activateKeyBtn.onclick = async () => {
    const hex = elements.keyInput.value.trim();
    if (!hex) {
      utils.showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á', 'danger');
      return;
    }
    
    try {
      await cryptoUtils.generateAESKey(hex);
      elements.keyPanel.style.display = 'none';
      elements.inputArea.style.display = 'flex';
      elements.sendBtn.disabled = false;
      elements.createFileBtn.style.display = 'block';
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
      setTimeout(() => {
        chatUtils.sendSystemMessage(`READY:${state.clientId}:${state.selfName}`);
      }, 300);
      
    } catch (e) {
      utils.showNotification(`‚ùå ${e.message}`, 'danger');
    }
  };
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
  elements.loadFileBtn.onclick = () => {
    elements.fileInput.click();
  };
  
  elements.fileInput.onchange = (e) => {
    const file = e.target.files[0];
    if (file && file.name.endsWith('.by')) {
      fileUtils.loadChristmasFile(file);
      elements.fileInput.value = '';
    } else {
      utils.showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .by', 'danger');
    }
  };
  
  // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
  elements.createFileBtn.onclick = fileUtils.createChristmasFile;
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  elements.sendBtn.onclick = chatUtils.send;
  
  elements.msgInput.onkeypress = (e) => {
    if (e.key === 'Enter') chatUtils.send();
  };
  
  // –ú–µ–Ω—é
  elements.menuBtn.onclick = () => {
    elements.menuPanel.classList.toggle('open');
  };
  
  // KILL-CHAT
  elements.killChatBtn.onclick = () => {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç —á–∞—Ç –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!')) {
      chatUtils.resetChat();
      elements.menuPanel.classList.remove('open');
    }
  };
  
  // –ö–ª–∏–∫ –≤–Ω–µ –º–µ–Ω—é
  document.addEventListener('click', (e) => {
    if (elements.menuPanel.classList.contains('open') && 
        !elements.menuPanel.contains(e.target) && 
        e.target !== elements.menuBtn) {
      elements.menuPanel.classList.remove('open');
    }
  });
});

// === –ü–†–û–í–ï–†–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø –ö–ê–ñ–î–£–Æ –ú–ò–ù–£–¢–£ ===
setInterval(() => {
  if (state.isConnected && state.currentTopic) {
    const now = Date.now();
    if (now - state.lastMessageTime > 60000) {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º heartbeat
      chatUtils.sendSystemMessage('HEARTBEAT');
    }
  }
}, 60000);
</script>
</body>
</html>
